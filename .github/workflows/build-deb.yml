name: Build .deb
on:
  push:
    tags: ['v*']
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: sudo apt-get update && sudo apt-get install -y dpkg-dev gettext
      - name: Build .deb
        run: |
          PKG=socialaberattelser
          VER=$(python3 -c "import re; print(re.search(r'__version__\s*=\s*\"([^\"]+)\"', open('socialaberattelser/__init__.py').read()).group(1))")
          DIR="${PKG}_${VER}_all"
          mkdir -p "$DIR/DEBIAN"
          mkdir -p "$DIR/usr/lib/python3/dist-packages/$PKG"
          mkdir -p "$DIR/usr/bin"
          mkdir -p "$DIR/usr/share/applications"
          mkdir -p "$DIR/usr/share/icons/hicolor/scalable/apps"
          cp $PKG/*.py "$DIR/usr/lib/python3/dist-packages/$PKG/"
          for po in po/*.po; do
            [ -f "$po" ] || continue
            lang=$(basename "$po" .po)
            mkdir -p "$DIR/usr/share/locale/$lang/LC_MESSAGES"
            msgfmt "$po" -o "$DIR/usr/share/locale/$lang/LC_MESSAGES/$PKG.mo"
          done
          cp data/se.danielnylander.$PKG.desktop "$DIR/usr/share/applications/"
          cp data/icons/se.danielnylander.$PKG.svg "$DIR/usr/share/icons/hicolor/scalable/apps/" 2>/dev/null || true
          printf '#!/usr/bin/env python3\nfrom %s.main import main\nmain()\n' "$PKG" > "$DIR/usr/bin/$PKG"
          chmod 755 "$DIR/usr/bin/$PKG"
          cat > "$DIR/DEBIAN/control" << EOF
          Package: $PKG
          Version: $VER
          Section: utils
          Priority: optional
          Architecture: all
          Depends: python3, python3-gi, gir1.2-gtk-4.0, gir1.2-adw-1
          Maintainer: Daniel Nylander <daniel@danielnylander.se>
          Description: Create and view social stories with images for autism
          Homepage: https://www.autismappar.se
          EOF
          sed -i 's/^          //' "$DIR/DEBIAN/control"
          dpkg-deb --build "$DIR"
      - name: Upload to release
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VER=$(python3 -c "import re; print(re.search(r'__version__\s*=\s*\"([^\"]+)\"', open('socialaberattelser/__init__.py').read()).group(1))")
          gh release upload "${GITHUB_REF_NAME}" socialaberattelser_${VER}_all.deb --clobber || true
