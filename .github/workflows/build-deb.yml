name: Build DEB
on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: sudo apt-get update && sudo apt-get install -y dpkg-dev gettext
      - name: Get version
        id: ver
        run: |
          VER="${{ github.event.release.tag_name }}"
          VER="${VER#v}"
          if [ -z "$VER" ]; then
            VER=$(python3 -c "from src.socialaberattelser import __version__; print(__version__)")
          fi
          echo "version=$VER" >> $GITHUB_OUTPUT
      - name: Build
        run: |
          PKG="socialaberattelser"
          VER="${{ steps.ver.outputs.version }}"
          DIR="build/${PKG}_${VER}_all"
          mkdir -p "$DIR/DEBIAN"
          mkdir -p "$DIR/usr/lib/python3/dist-packages/socialaberattelser"
          mkdir -p "$DIR/usr/bin"
          mkdir -p "$DIR/usr/share/applications"
          cp src/socialaberattelser/*.py "$DIR/usr/lib/python3/dist-packages/socialaberattelser/"
          for po in po/*.po; do
            [ -f "$po" ] || continue
            lang=$(basename "$po" .po)
            mkdir -p "$DIR/usr/share/locale/$lang/LC_MESSAGES"
            msgfmt "$po" -o "$DIR/usr/share/locale/$lang/LC_MESSAGES/socialaberattelser.mo"
          done
          printf '#!/usr/bin/env python3\nfrom socialaberattelser.main import main\nmain()\n' > "$DIR/usr/bin/socialaberattelser"
          chmod 755 "$DIR/usr/bin/socialaberattelser"
          [ -f "data/socialaberattelser.desktop" ] && cp "data/socialaberattelser.desktop" "$DIR/usr/share/applications/"
          printf 'Package: socialaberattelser\nVersion: %s\nSection: utils\nPriority: optional\nArchitecture: all\nDepends: python3, python3-gi, gir1.2-gtk-4.0, gir1.2-adw-1\nMaintainer: Daniel Nylander <daniel@danielnylander.se>\nDescription: Social stories for children\n' "$VER" > "$DIR/DEBIAN/control"
          dpkg-deb --build "$DIR"
      - name: Upload
        uses: softprops/action-gh-release@v2
        if: github.event_name == 'release'
        with:
          files: build/*.deb
